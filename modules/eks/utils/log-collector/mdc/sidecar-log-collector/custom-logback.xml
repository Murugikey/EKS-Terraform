<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <springProperty name="SPRING_APPLICATION_NAME" source="spring.application.name"/>
    <property name="SPRING_APPLICATION_CONTEXT_NAME" value="${PROP_SPRING_APPLICATION_CONTEXT_NAME:-${SPRING_APPLICATION_NAME}}"/>
    <contextName>${SPRING_APPLICATION_CONTEXT_NAME}</contextName>
    
    <springProperty name="BUILD_VERSION_SPRING_PROP" source="build.version"/>
    <define name="BUILD_INFO_VERSION" class="com.wit.mpesa.commonlogslib.logback.ResourcePropertyDefiner">
        <resource>META-INF/build-info.properties</resource>
        <key>build.version</key>
        <defaultValueOnMissingKey>${build.version}</defaultValueOnMissingKey>
        <defaultValueOnMissingResource>${build.version:-BUILD_INFO_NOT_FOUND}</defaultValueOnMissingResource>
    </define>
    <property name="BUILD_VERSION" value="${BUILD_VERSION:-${BUILD_VERSION_SPRING_PROP:-${BUILD_INFO_VERSION}}}"/>
    <springProperty name="PROP_DEFAULT_LOG_FILENAME" source="log.file.microservice.default"/>
    <property name="LOG_FILENAME_DEFAULT" value="${LOG_FILENAME_DEFAULT:-${PROP_DEFAULT_LOG_FILENAME:-${SPRING_APPLICATION_CONTEXT_NAME}-${HOSTNAME}.log}}"/>
    <springProperty name="PROP_SPRING_LOG_FILENAME" source="log.file.microservice.spring"/>
    <property name="LOG_FILENAME_SPRING" value="${LOG_FILENAME_SPRING:-${PROP_SPRING_LOG_FILENAME:-${SPRING_APPLICATION_CONTEXT_NAME}-spring.${HOSTNAME}.log}}"/>
    
    <property name="CONSOLE_LOG_PATTERN" value="${CONSOLE_LOG_PATTERN:-%clr(%d{${LOG_DATEFORMAT_PATTERN:-yyyy-MM-dd HH:mm:ss.SSS}}){faint} [${LOG_BUILD_VERSION_PATTERN:-${BUILD_VERSION}}] %clr(%highlight(${LOG_LEVEL_PATTERN:-%5p}) [%X{transactionRefID}] [%X{correlationID}]) %clr(${PID:- }){magenta} %clr(---){faint} %clr([%15.15t]){faint} %clr(%-40.40logger{39}){cyan} %clr(:){faint} %m%n${LOG_EXCEPTION_CONVERSION_WORD:-%wEx}}"/>
    <property name="FILE_LOG_PATTERN" value="${FILE_LOG_PATTERN:-%d{${LOG_DATEFORMAT_PATTERN:-yyyy-MM-dd HH:mm:ss.SSS}} [${LOG_BUILD_VERSION_PATTERN:-${BUILD_VERSION}}] ${LOG_LEVEL_PATTERN:-%5p} [%X{transactionRefID}] [%X{correlationID}] ${PID:- } --- [%t] %logger{59} : %m%n${LOG_EXCEPTION_CONVERSION_WORD:-%wEx}}"/>
    
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>
    <include resource="com/wit/mpesa/commonlogslib/logback/logging-group-web-defaults.xml"/>
    <include resource="com/wit/mpesa/commonlogslib/logback/logging-group-sql-defaults.xml"/>
    
    <springProperty name="PROP_LOG_FOLDER" source="log.folder"/>
    <property name="LOG_PATH" value="${LOG_PATH:-${PROP_LOG_FOLDER}}"/>
    <property name="LOG_PATH_ARCHIVE" value="${LOG_PATH_ARCHIVE:-${LOG_PATH}}"/>
    <springProperty name="PROP_LOG_FOLDER_MDC" source="log.folder.mdc"/>
    <property name="LOG_PATH_MDC" value="${LOG_PATH_MDC:-${PROP_LOG_FOLDER_MDC:-${LOG_PATH}/mdc}}}"/>
    <property name="LOG_PATH_MDC_ARCHIVE" value="${LOG_PATH_MDC_ARCHIVE:-${LOG_PATH_MDC}}"/>
    
    <property name="ROLLING_FILENAME_SUFFIX" value="${ROLLING_FILENAME_SUFFIX:-.%d{yyyy-MM-dd-HH}.%i.log}"/>
    <property name="LOG_FILE_MAX_SIZE" value="${LOG_FILE_MAX_SIZE:-50MB}"/>
    <property name="LOG_FILE_MAX_HISTORY" value="${LOG_FILE_MAX_HISTORY:-24}"/>
    <property name="LOG_FILE_TOTAL_SIZE_CAP" value="${LOG_FILE_TOTAL_SIZE_CAP:-200MB}"/>
    <springProperty name="PROP_LOGBACK_ASYNC_NEVER_BLOCK" source="logback.async.neverBlock"/>
    <springProperty name="PROP_LOGBACK_ASYNC_QUEUE_SIZE" source="logback.async.queueSize"/>
    <springProperty name="PROP_LOGBACK_ASYNC_DISCARDING_THRESHOLD" source="logback.async.discarding-threshold"/>
    <springProperty name="PROP_LOGBACK_ASYNC_MAX_FLUSH_TIME" source="logback.async.discarding-threshold"/>
    <property name="LOGBACK_ASYNC_NEVER_BLOCK" value="${LOGBACK_ASYNC_NEVER_BLOCK:-${PROP_LOGBACK_ASYNC_NEVER_BLOCK:-true}}"/>
    <property name="LOGBACK_ASYNC_QUEUE_SIZE" value="${LOGBACK_ASYNC_QUEUE_SIZE:-${PROP_LOGBACK_ASYNC_QUEUE_SIZE:-1024}}"/>
    <property name="LOGBACK_ASYNC_DISCARDING_THRESHOLD" value="${LOGBACK_ASYNC_DISCARDING_THRESHOLD:-${PROP_LOGBACK_ASYNC_DISCARDING_THRESHOLD:-0}}"/>
    <property name="LOGBACK_ASYNC_MAX_FLUSH_TIME" value="${LOGBACK_ASYNC_MAX_FLUSH_TIME:-${PROP_LOGBACK_ASYNC_MAX_FLUSH_TIME:-1000}}"/>
    
    <springProperty name="PROP_LOG_MSG_MASKING_STRING_ENABLED" source="logging.mask.to-string.enabled"/>
    <springProperty name="PROP_LOG_MSG_MASKING_STRING_REGEX" source="logging.mask.to-string.regex"/>
    <springProperty name="PROP_LOG_MSG_MASKING_STRING_PLACEHOLDER" source="logging.mask.to-string.placeholder"/>
    <springProperty name="PROP_LOG_MSG_MASKING_JSON_ENABLED" source="logging.mask.json.enabled"/>
    <springProperty name="PROP_LOG_MSG_MASKING_JSON_REGEX" source="logging.mask.json.regex"/>
    <springProperty name="PROP_LOG_MSG_MASKING_JSON_PLACEHOLDER" source="logging.mask.json.placeholder"/>
    <property name="LOG_MSG_MASKING_STRING_ENABLED" value="${LOG_MSG_MASKING_STRING_ENABLED:-${PROP_LOG_MSG_MASKING_STRING_ENABLED:-false}}"/>
    <property name="LOG_MSG_MASKING_STRING_REGEX" value="${LOG_MSG_MASKING_STRING_REGEX:-${PROP_LOG_MSG_MASKING_STRING_REGEX}}"/>
    <property name="LOG_MSG_MASKING_STRING_PLACEHOLDER" value="${LOG_MSG_MASKING_STRING_PLACEHOLDER:-${PROP_LOG_MSG_MASKING_STRING_PLACEHOLDER}}"/>
    <property name="LOG_MSG_MASKING_JSON_ENABLED" value="${LOG_MSG_MASKING_JSON_ENABLED:-${PROP_LOG_MSG_MASKING_JSON_ENABLED:-false}}"/>
    <property name="LOG_MSG_MASKING_JSON_REGEX" value="${LOG_MSG_MASKING_JSON_REGEX:-${PROP_LOG_MSG_MASKING_JSON_REGEX}}"/>
    <property name="LOG_MSG_MASKING_JSON_PLACEHOLDER" value="${LOG_MSG_MASKING_JSON_PLACEHOLDER:-${PROP_LOG_MSG_MASKING_JSON_PLACEHOLDER}}"/>
    
    <springProperty name="PROP_EXCEPTION_STACK_LINES" source="log.exception-stack.lines"/>
    <property name="EXCEPTION_STACK_LINES" value="${EXCEPTION_STACK_LINES:-${PROP_EXCEPTION_STACK_LINES:-5}}"/>
    
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="ch.qos.logback.core.encoder.LayoutWrappingEncoder">
            <layout class="com.wit.mpesa.commonlogslib.logback.MaskingPatternLayout">
                <toStringMaskingEnabled>${LOG_MSG_MASKING_STRING_ENABLED}</toStringMaskingEnabled>
                <toStringMaskingRegex>${LOG_MSG_MASKING_STRING_REGEX}</toStringMaskingRegex>
                <toStringMaskingPlaceholder>${LOG_MSG_MASKING_STRING_PLACEHOLDER}</toStringMaskingPlaceholder>
                <jsonMaskingEnabled>${LOG_MSG_MASKING_JSON_ENABLED}</jsonMaskingEnabled>
                <jsonMaskingRegex>${LOG_MSG_MASKING_JSON_REGEX}</jsonMaskingRegex>
                <jsonMaskingPlaceholder>${LOG_MSG_MASKING_JSON_PLACEHOLDER}</jsonMaskingPlaceholder>
                <pattern>${CONSOLE_LOG_PATTERN}</pattern>
            </layout>
        </encoder>
    </appender>
    <appender name="FILE-DEFAULT" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${LOG_FILENAME_DEFAULT}</file>
        <encoder class="ch.qos.logback.core.encoder.LayoutWrappingEncoder">
            <layout class="com.wit.mpesa.commonlogslib.logback.MaskingPatternLayout">
                <toStringMaskingEnabled>${LOG_MSG_MASKING_STRING_ENABLED}</toStringMaskingEnabled>
                <toStringMaskingRegex>${LOG_MSG_MASKING_STRING_REGEX}</toStringMaskingRegex>
                <toStringMaskingPlaceholder>${LOG_MSG_MASKING_STRING_PLACEHOLDER}</toStringMaskingPlaceholder>
                <jsonMaskingEnabled>${LOG_MSG_MASKING_JSON_ENABLED}</jsonMaskingEnabled>
                <jsonMaskingRegex>${LOG_MSG_MASKING_JSON_REGEX}</jsonMaskingRegex>
                <jsonMaskingPlaceholder>${LOG_MSG_MASKING_JSON_PLACEHOLDER}</jsonMaskingPlaceholder>
                <pattern>${FILE_LOG_PATTERN}</pattern>
            </layout>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH_ARCHIVE}/${LOG_FILENAME_DEFAULT}${ROLLING_FILENAME_SUFFIX}</fileNamePattern>
            <maxFileSize>${LOG_FILE_MAX_SIZE}</maxFileSize>
            <maxHistory>${LOG_FILE_MAX_HISTORY}</maxHistory>
            <totalSizeCap>${LOG_FILE_TOTAL_SIZE_CAP}</totalSizeCap>
        </rollingPolicy>
    </appender>
    <appender name="FILE-SPRING" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${LOG_FILENAME_SPRING}</file>
        <encoder class="ch.qos.logback.core.encoder.LayoutWrappingEncoder">
            <layout class="com.wit.mpesa.commonlogslib.logback.MaskingPatternLayout">
                <toStringMaskingEnabled>${LOG_MSG_MASKING_STRING_ENABLED}</toStringMaskingEnabled>
                <toStringMaskingRegex>${LOG_MSG_MASKING_STRING_REGEX}</toStringMaskingRegex>
                <toStringMaskingPlaceholder>${LOG_MSG_MASKING_STRING_PLACEHOLDER}</toStringMaskingPlaceholder>
                <jsonMaskingEnabled>${LOG_MSG_MASKING_JSON_ENABLED}</jsonMaskingEnabled>
                <jsonMaskingRegex>${LOG_MSG_MASKING_JSON_REGEX}</jsonMaskingRegex>
                <jsonMaskingPlaceholder>${LOG_MSG_MASKING_JSON_PLACEHOLDER}</jsonMaskingPlaceholder>
                <pattern>${FILE_LOG_PATTERN}</pattern>
            </layout>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH_ARCHIVE}/${LOG_FILENAME_SPRING}${ROLLING_FILENAME_SUFFIX}</fileNamePattern>
            <maxFileSize>${LOG_FILE_MAX_SIZE}</maxFileSize>
            <maxHistory>${LOG_FILE_MAX_HISTORY}</maxHistory>
            <totalSizeCap>${LOG_FILE_TOTAL_SIZE_CAP}</totalSizeCap>
        </rollingPolicy>
    </appender>
    
    <springProperty name="PROP_LOGGING_LEVEL_ROOT" source="logging.level.root"/>
    <springProperty name="PROP_DEFAULT_LOG_FILENAME" source="log.file.microservice.default"/>
    <property name="LOG_FILENAME_DEFAULT" value="${LOG_FILENAME_DEFAULT:-${PROP_DEFAULT_LOG_FILENAME:-${SPRING_APPLICATION_CONTEXT_NAME}-${HOSTNAME}.log}}" />
    
    <property name="MDC_EXCEPTION_STACK_LINES" value="${MDC_EXCEPTION_STACK_LINES:-${EXCEPTION_STACK_LINES}}"/>
    
    <property name="MDC_FILE_LOG_PATTERN" value='${MDC_FILE_LOG_PATTERN:-\{"time":"%d{yyyy-MM-dd HH:mm:ss.SSS}", "Service":"${CONTEXT_NAME}", "Version":"${BUILD_VERSION}", "LogLevel":"%-5p", "TransactionRefID":"%X{transactionRefID}", "CorrelationID":"%X{correlationID}", "OperationName":"%X{operationName}", "SourceIP":"%X{sourceIP}", "SourceSystem":"%X{sourceSystem}", "LogObject":"%X{requestResponse}", "Exception":"%xException{\${MDC_EXCEPTION_STACK_LINES}}", "TransactionCost":"%X{transactionCost}", "TransactionEndpoint":"%X{transactionEndpoint}", "LogDetailedMessage":"%msg -end_detail_message"\} %n}'/>
    <appender name="FILE-MDC" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH_MDC}/${LOG_FILENAME_DEFAULT}</file>
        <encoder class="ch.qos.logback.core.encoder.LayoutWrappingEncoder">
            <layout class="com.wit.mpesa.commonlogslib.logback.MaskingPatternLayout">
                <toStringMaskingEnabled>${LOG_MSG_MASKING_STRING_ENABLED}</toStringMaskingEnabled>
                <toStringMaskingRegex>${LOG_MSG_MASKING_STRING_REGEX}</toStringMaskingRegex>
                <toStringMaskingPlaceholder>${LOG_MSG_MASKING_STRING_PLACEHOLDER}</toStringMaskingPlaceholder>
                <jsonMaskingEnabled>${LOG_MSG_MASKING_JSON_ENABLED}</jsonMaskingEnabled>
                <jsonMaskingRegex>${LOG_MSG_MASKING_JSON_REGEX}</jsonMaskingRegex>
                <jsonMaskingPlaceholder>${LOG_MSG_MASKING_JSON_PLACEHOLDER}</jsonMaskingPlaceholder>
                <pattern>${MDC_FILE_LOG_PATTERN}</pattern>
            </layout>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH_MDC_ARCHIVE}/${LOG_FILENAME_DEFAULT}${ROLLING_FILENAME_SUFFIX}</fileNamePattern>
            <maxFileSize>${LOG_FILE_MAX_SIZE}</maxFileSize>
            <maxHistory>${LOG_FILE_MAX_HISTORY}</maxHistory>
            <totalSizeCap>${LOG_FILE_TOTAL_SIZE_CAP}</totalSizeCap>
        </rollingPolicy>
    </appender>
 
    <appender name="ASYNC-FILE-MDC" class="ch.qos.logback.classic.AsyncAppender">
        <neverBlock>${LOGBACK_ASYNC_NEVER_BLOCK}</neverBlock>
        <queueSize>${LOGBACK_ASYNC_QUEUE_SIZE}</queueSize>
        <discardingThreshold>${LOGBACK_ASYNC_DISCARDING_THRESHOLD}</discardingThreshold>
        <maxFlushTime>${LOGBACK_ASYNC_MAX_FLUSH_TIME}</maxFlushTime>
        <appender-ref ref="FILE-MDC"/>
    </appender>
    <logger name="com.wit.mpesa" additivity="false">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="FILE-DEFAULT"/>
        <appender-ref ref="ASYNC-FILE-MDC"/>
    </logger>
    <logger name="org.springframework" additivity="false">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="FILE-SPRING"/>
    </logger>
    <root level="${LOGGING_LEVEL_ROOT:-${PROP_LOGGING_LEVEL_ROOT:-INFO}}">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="FILE-DEFAULT"/>
    </root>
</configuration>